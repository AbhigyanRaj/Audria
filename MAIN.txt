================================================================================
                    AUDRIA AMD - MASTER IMPLEMENTATION PLAN
================================================================================

Project: Advanced Answering Machine Detection System (4 Strategies)
Status: IN PROGRESS - Debugging Phase
Last Updated: 2025-11-03 15:21 IST

================================================================================
CURRENT ENVIRONMENT STATUS
================================================================================

✅ CREDENTIALS REQUIRED:
   - Twilio Account SID (set in .env)
   - Twilio Auth Token (set in .env)
   - Twilio Phone Number (set in .env)
   - Gemini API Key (set in .env)
   - HuggingFace API Key (set in .env)
   
✅ INFRASTRUCTURE:
   - Database: PostgreSQL (localhost:5432) - RUNNING
   - Next.js Server: localhost:3000 - RUNNING
   - WebSocket Server: localhost:8080 - RUNNING
   - ngrok (port 3000): https://01cb4af52133.ngrok-free.app
   - ngrok (port 8080): wss://4f655e5164cc.ngrok-free.app

================================================================================
CRITICAL ISSUE - RESOLVED ✅
================================================================================

✅ FIXED: TwiML Webhook Issue
   
   PROBLEM WAS:
   - ngrok tunnel for port 3000 was offline
   - Twilio couldn't reach webhook endpoint
   
   SOLUTION APPLIED:
   ✅ Restarted ngrok on port 3000
   ✅ Updated WEBHOOK_BASE_URL in .env.local
   ✅ Added comprehensive logging to all endpoints
   ✅ TwiML now working correctly
   
   CURRENT STATUS:
   ✅ Calls completing successfully
   ✅ TwiML endpoint receiving requests
   ✅ Database updates working
   ⚠️ Twilio returns "unknown" on trial account (expected)
   ⚠️ Jambonz callback was failing (SSL error) - NOW FIXED

================================================================================
AMD STRATEGIES - IMPLEMENTATION STATUS
================================================================================

STRATEGY 1: TWILIO NATIVE AMD
   Status: ⚠️ PARTIALLY IMPLEMENTED
   
   What Works:
   ✅ machineDetection: 'Enable' parameter set
   ✅ Synchronous AMD via AnsweredBy parameter
   ✅ Database schema supports detection field
   
   What's Missing:
   ❌ TwiML endpoint not being called (blocking issue)
   ❌ AMD result not saved to database
   ❌ Hangup-on-machine logic not triggered
   
   Files Involved:
   - /api/calls/initiate/route.ts (call setup)
   - /api/calls/twiml/route.ts (TwiML response + AMD save)
   - /api/amd/twilio-callback/route.ts (async callback)
   
   Next Steps:
   1. Fix TwiML webhook issue
   2. Verify AnsweredBy parameter is received
   3. Save detection to database
   4. Test hangup on machine detection

---

STRATEGY 2: JAMBONZ SIP-ENHANCED AMD
   Status: ⚠️ HEURISTIC IMPLEMENTATION
   
   What Works:
   ✅ Heuristic analysis (call timing, duration)
   ✅ Callback endpoint created
   ✅ Database integration
   
   What's Missing:
   ❌ Not using real Jambonz SIP server (as per assignment)
   ❌ No actual SIP metrics analysis
   ❌ TwiML not triggering Jambonz callback
   
   Files Involved:
   - /api/amd/jambonz-callback/route.ts
   - /api/calls/twiml/route.ts (trigger point)
   
   Current Approach:
   - Analyzes call answer time (<2s = human, >4s = machine)
   - Uses Twilio's AnsweredBy as assist signal
   - Calculates confidence based on patterns
   
   Next Steps:
   1. Fix TwiML webhook to trigger Jambonz analysis
   2. Consider: Deploy real Jambonz instance OR keep heuristics
   3. Improve heuristic accuracy with more patterns

---

STRATEGY 3: HUGGINGFACE ML MODEL AMD
   Status: ❌ NOT IMPLEMENTED (REAL-TIME AUDIO MISSING)
   
   What Exists:
   ✅ Service wrapper: /lib/huggingface.ts
   ✅ API key provided
   ✅ Placeholder endpoint: /api/amd/huggingface-stream/route.ts
   
   What's Missing:
   ❌ Real-time audio streaming from Twilio
   ❌ Audio format conversion (mulaw → WAV)
   ❌ HuggingFace Inference API integration
   ❌ WebSocket handler for Media Streams
   
   Required Implementation:
   1. TwiML: Add <Start><Stream url="ws://..."/></Start>
   2. WebSocket: Receive Twilio Media Stream events
   3. Audio: Convert mulaw → PCM → WAV
   4. API: Send to HuggingFace wav2vec2 model
   5. Response: Parse classification result
   6. Database: Save detection + confidence
   7. Control: Hangup on machine via Twilio REST API
   
   Model: facebook/wav2vec2-base-960h
   Endpoint: https://api-inference.huggingface.co/models/...
   
   Next Steps:
   1. Fix TwiML webhook issue first
   2. Implement WebSocket Media Stream handler
   3. Test audio conversion pipeline
   4. Integrate HuggingFace API

---

STRATEGY 4: GEMINI FLASH 2.5 LLM AMD
   Status: ⚠️ PARTIALLY IMPLEMENTED (WEBSOCKET ISSUE)
   
   What Exists:
   ✅ Service wrapper: /lib/gemini.ts (audio analysis)
   ✅ Audio converter: /lib/audio-converter.ts (mulaw→WAV)
   ✅ Stream handler: /lib/gemini-stream-handler.ts
   ✅ WebSocket server: port 8080 initialized
   ✅ API key provided
   
   What's Missing:
   ❌ TwiML not starting Media Stream (disabled for debugging)
   ❌ WebSocket connection not tested
   ❌ Gemini API integration not tested with real audio
   
   Current Issue:
   - TwiML temporarily disabled <Stream> element
   - Reason: Basic call flow broken (webhook issue)
   - Need to fix webhook before testing WebSocket
   
   Next Steps:
   1. Fix TwiML webhook issue
   2. Re-enable <Stream> in TwiML for Gemini
   3. Test WebSocket connection with ngrok
   4. Verify Gemini API receives audio
   5. Test AMD decision logic

================================================================================
LOGGING STRATEGY - TO BE IMPLEMENTED
================================================================================

ENDPOINT: /api/calls/initiate
   Add Logs:
   ✅ Call options (already present)
   + Twilio API response (full object)
   + Database call record created (ID, callSid)
   + AMD event created (ID, strategy)
   + Any errors with stack trace

ENDPOINT: /api/calls/twiml
   Add Logs:
   + Request received (timestamp, headers)
   + Query params (strategy, CallSid)
   + Form data (AnsweredBy, CallStatus)
   + TwiML generated (full XML)
   + Database operations (find, update)
   + Response sent (status, headers)
   + Any errors with stack trace

ENDPOINT: /api/calls/webhook
   Add Logs:
   + Webhook received (CallSid, CallStatus)
   + Database update (before/after values)
   + Any errors with stack trace

ENDPOINT: /api/amd/twilio-callback
   Add Logs:
   + Callback received (CallSid, AnsweredBy)
   + AMD result parsed
   + Database update
   + Any errors

ENDPOINT: /api/amd/jambonz-callback
   Add Logs:
   + Callback received
   + Heuristic analysis details
   + Decision + confidence
   + Database update

WEBSOCKET: Gemini/HuggingFace Streams
   Add Logs:
   + Connection opened (callSid)
   + Media events received (count, bytes)
   + Audio buffer status (size, duration)
   + Analysis triggered
   + API response
   + Database update
   + Connection closed

================================================================================
IMPLEMENTATION PLAN - STEP BY STEP
================================================================================

PHASE 1: FIX CRITICAL BLOCKING ISSUE [HIGH PRIORITY]
   
   Step 1.1: Add Comprehensive Logging
   - File: /api/calls/twiml/route.ts
   - Add: Request received log at very start
   - Add: All parameters logged
   - Add: TwiML XML logged before sending
   - Add: Error handling with full stack trace
   
   Step 1.2: Test ngrok Webhook
   - Command: curl https://01cb4af52133.ngrok-free.app/api/calls/twiml?strategy=twilio
   - Verify: Logs appear in terminal
   - Verify: Valid TwiML XML returned
   
   Step 1.3: Check Twilio Debugger
   - URL: https://console.twilio.com/us1/monitor/logs/debugger
   - Look for: Webhook errors
   - Look for: TwiML parsing errors
   
   Step 1.4: Fix Root Cause
   - Based on logs, fix the issue
   - Test with simple TwiML first
   - Gradually add complexity

---

PHASE 2: IMPLEMENT TWILIO NATIVE AMD [HIGH PRIORITY]
   
   Step 2.1: Verify TwiML Receives AnsweredBy
   - Log: AnsweredBy parameter value
   - Test: Call and check logs
   
   Step 2.2: Save AMD Result to Database
   - Find: Call by CallSid
   - Update: AMDEvent with detection, confidence
   - Log: Database update success
   
   Step 2.3: Implement Hangup Logic
   - If: AnsweredBy starts with "machine"
   - Then: Return <Hangup/> in TwiML
   - Else: Continue call flow
   
   Step 2.4: Test End-to-End
   - Call voicemail number (Costco: 1-800-774-2678)
   - Verify: Machine detected
   - Verify: Call hung up
   - Verify: Database updated

---

PHASE 3: IMPLEMENT JAMBONZ AMD [MEDIUM PRIORITY]
   
   Step 3.1: Trigger from TwiML
   - When: strategy=jambonz
   - Action: Async POST to /api/amd/jambonz-callback
   - Pass: CallSid, CallStatus, AnsweredBy
   
   Step 3.2: Enhance Heuristics
   - Add: More timing patterns
   - Add: Call duration analysis
   - Add: Confidence calculation improvements
   
   Step 3.3: Test and Tune
   - Test: Multiple calls
   - Measure: Accuracy
   - Tune: Thresholds

---

PHASE 4: IMPLEMENT HUGGINGFACE AMD [HIGH PRIORITY]
   
   Step 4.1: Create WebSocket Handler
   - File: /lib/huggingface-stream-handler.ts
   - Handle: Twilio Media Stream events
   - Buffer: Audio chunks (3 seconds minimum)
   
   Step 4.2: Audio Conversion
   - Use: /lib/audio-converter.ts
   - Convert: mulaw → PCM → WAV
   - Format: 8kHz, mono, 16-bit
   
   Step 4.3: HuggingFace API Integration
   - Endpoint: POST to Inference API
   - Model: facebook/wav2vec2-base-960h
   - Headers: Authorization with API key
   - Body: Audio file (WAV)
   
   Step 4.4: Parse Response
   - Extract: Classification labels
   - Determine: Human vs Machine
   - Calculate: Confidence score
   
   Step 4.5: Update TwiML
   - Add: <Stream url="wss://..."/> for strategy=huggingface
   - Point to: WebSocket server on port 8080
   
   Step 4.6: Test End-to-End
   - Make call
   - Verify: WebSocket connection
   - Verify: Audio received
   - Verify: HuggingFace API called
   - Verify: Detection saved

---

PHASE 5: IMPLEMENT GEMINI AMD [HIGH PRIORITY]
   
   Step 5.1: Re-enable Media Stream in TwiML
   - Uncomment: <Stream> element
   - URL: wss://4f655e5164cc.ngrok-free.app?callSid=...
   
   Step 5.2: Test WebSocket Connection
   - Verify: Connection opened log
   - Verify: Media events received
   
   Step 5.3: Test Gemini API
   - Verify: Audio sent to Gemini
   - Verify: JSON response parsed
   - Verify: Detection + reasoning extracted
   
   Step 5.4: Test Hangup Logic
   - If: Machine detected (confidence >0.7)
   - Then: Call Twilio REST API to hangup
   - Verify: Call ends
   
   Step 5.5: Test End-to-End
   - Make call
   - Say "Hello"
   - Verify: Human detected
   - Verify: Call continues

---

PHASE 6: TESTING & VALIDATION [MEDIUM PRIORITY]
   
   Test Scenarios:
   1. Voicemail (Costco): Expect machine detection + hangup
   2. Human pickup: Expect human detection + continue
   3. Timeout (no answer): Expect fallback to human
   4. Low confidence: Expect fallback to human
   
   For Each Strategy:
   - Run 5 test calls
   - Measure: Accuracy, latency, cost
   - Document: Results in comparison table

================================================================================
KNOWN ISSUES & SOLUTIONS
================================================================================

ISSUE 1: TwiML Webhook Not Called
   Status: CRITICAL - BLOCKING ALL STRATEGIES
   Symptoms: Call initiates, but TwiML endpoint never receives request
   Possible Causes:
   - ngrok blocking Twilio webhooks
   - TwiML URL malformed
   - Twilio can't reach endpoint
   Solution: Add logging, test with curl, check Twilio debugger

ISSUE 2: WebSocket on Different Port
   Status: MEDIUM - AFFECTS GEMINI & HUGGINGFACE
   Symptoms: ngrok only forwards port 3000, not 8080
   Solution: Use separate ngrok tunnel for port 8080 (already done)
   
ISSUE 3: Audio Format Conversion
   Status: LOW - IMPLEMENTATION DETAIL
   Symptoms: Twilio sends mulaw, AI models need WAV
   Solution: Use audio-converter.ts (already implemented)

ISSUE 4: Trial Account Limitations
   Status: LOW - WORKAROUND AVAILABLE
   Symptoms: Async AMD not available on trial
   Solution: Use synchronous AMD via AnsweredBy parameter

================================================================================
FILE STRUCTURE & RESPONSIBILITIES
================================================================================

/api/calls/initiate/route.ts
   - Initiates outbound call via Twilio
   - Sets AMD parameters
   - Creates Call and AMDEvent records
   - Returns callSid to frontend

/api/calls/twiml/route.ts
   - Generates TwiML response for call flow
   - Saves synchronous AMD results (AnsweredBy)
   - Starts Media Stream for advanced strategies
   - Implements hangup-on-machine logic

/api/calls/webhook/route.ts
   - Receives Twilio status callbacks
   - Updates Call status in database
   - Logs call events

/api/amd/twilio-callback/route.ts
   - Receives async AMD callbacks (if available)
   - Parses AnsweredBy, MachineDetectionDuration
   - Updates AMDEvent in database

/api/amd/jambonz-callback/route.ts
   - Receives call data for heuristic analysis
   - Analyzes timing patterns
   - Calculates confidence
   - Updates AMDEvent

/api/amd/gemini-media-stream/route.ts
   - Placeholder for Next.js WebSocket route
   - Actual handler in /lib/gemini-stream-handler.ts

/lib/gemini-stream-handler.ts
   - Handles Twilio Media Stream WebSocket
   - Buffers audio chunks
   - Calls Gemini API for analysis
   - Updates database
   - Hangs up call if machine detected

/lib/audio-converter.ts
   - Converts mulaw → PCM → WAV
   - Creates WAV headers
   - Manages audio buffer

/lib/gemini.ts
   - Gemini API client
   - Audio analysis function
   - JSON response parsing

/lib/huggingface.ts
   - HuggingFace API client
   - Audio classification
   - Fallback heuristics

/lib/websocket-server.ts
   - Initializes WebSocket server on port 8080
   - Routes connections to appropriate handler

================================================================================
NEXT IMMEDIATE ACTIONS
================================================================================

1. Add comprehensive logging to /api/calls/twiml/route.ts
2. Test ngrok webhook with curl
3. Check Twilio debugger for errors
4. Fix TwiML webhook issue
5. Test Twilio Native AMD end-to-end
6. Implement HuggingFace WebSocket handler
7. Re-enable Gemini Media Stream
8. Test all 4 strategies
9. Create comparison table with results

================================================================================
SUCCESS CRITERIA
================================================================================

✅ All 4 AMD strategies implemented
✅ Real-time audio streaming working (Gemini, HuggingFace)
✅ Hangup-on-machine logic working
✅ Database correctly stores detection results
✅ Frontend displays AMD results in call history
✅ Comprehensive logging for debugging
✅ Tested with voicemail and human pickup
✅ Comparison table with accuracy/latency/cost

================================================================================
END OF MASTER PLAN
================================================================================
